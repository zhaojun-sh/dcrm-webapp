<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <title><%= title %></title>
    <link href="./bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="./bootstrap-3.3.7/css/bootstrap-datetimepicker.min.css" rel="stylesheet"
        type="text/css" />
    <style type="text/css">
    html,body{height: 100%; min-height: 100%;}
    #mainContent{height: auto; min-height: 100%; padding:40px 0 100px 0;}
        .nav-tabs li
        {
            font-weight: bold;
        }
        .tab-pane
        {
            padding: 10px 0;
        }
        .masktext{
            color: #fff;
            font-size: 18px;
            font-weight: bolder;
        }
        #tab_content{display: none;}
        #footer{position: relative;bottom: 0;left: 0; text-align: center;height: 80px; width: 100%; background: #fff;color: #666;}
        #footer .footer{ text-align: center;border-top: 1px solid #ddd; margin-top: -80px;}
        .copyright{display: inline-block;margin: 30px 10px 0 10px;}
        .logo{display: inline-block; width: 120px;margin-top: 25px; float: left;}
        .smicon img,.logo img{width: 100%;}
        .smicon{display: inline-block; float: right; width: 30px;margin:25px 0 0 10px;}

    </style>
</head>
<body>
    <div id="mainContent" class="container">
        <div class="clearfix" style="margin-bottom: 10px;">
            <span style="font-size: 20px; font-weight: bold;">Asset Lock In and Lock Out Service
            </span>
            <div class="pull-right form-inline">
                <label for="selNode">
                    Financial Services Provider</label>&nbsp;&nbsp;
                <select id="selNode" class="form-control">
                    <!-- <option value="http://47.92.168.85:40405">Bank of China</option>
                    <option value="http://54.164.7.63:40405">Bank of America</option>
                    <option value="http://104.210.49.28:40405">Bank of Europe</option>
                    <option value="http://118.25.173.24:40405">Bank of Japan</option> -->
                </select></div>
        </div>
        <div class="alert alert-warning alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  <strong>Warning!</strong> DCRM.network is a testnet, only for testing, do not transfer the mainnet coin to avoid asset loss.
</div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    Generate Account</h3>
            </div>
            <div class="panel-body" >
                <form>
                <div class="form-group">
                    <label for="userPassword">
                        Private Key</label>
                    <input type="text" class="form-control" id="privateKey" name="privateKey">
                    <input type="hidden" id="pubKey" name="pubKey">
                </div>
                <button id="btnCreateKey" type="button" class="btn btn-primary" onclick="createKey(this)">
                    Generate Private Key</button>
                    <button id="btnImportKey" type="button" class="btn btn-primary" onclick="importKey(this)">
                    Import Private Key</button>
                    <span id="priv_warn"  style="display: none;color:#31708f; margin-left: 40px; font-size:16px;">Please save the privatekey (for testing only).</span>
                    <div id="newAccount">
                    </div>
                </form>
            </div>
        </div>
        <div style="margin:10px 0;">
            <label for="selCoin">
                Coin Type</label>
            <select id="selCoin" class="form-control" onchange="changecoin(this)">
                <option value="ETH">Ethereum</option>
                <option value="BTC">BitCoin</option>
                <option value="FSN">Fusion(ERC20)</option>
                <option value="TRX">TRON(ERC20)</option>
            </select>
        </div>
        <div id="tab_content">
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#lockin" aria-controls="lockin" role="tab"
                    data-toggle="tab">Lock In</a></li>
                <li role="presentation"><a href="#lockout" aria-controls="lockout" role="tab" data-toggle="tab">
                    Lock Out</a></li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="lockin">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                DCRM Test (Lock In)</h3>
                        </div>
                        <div class="panel-body">
                            <form>
                            <div class="form-group  form-inline">
                               <!--  <label for="selCoin">
                                    Coin Type</label>
                                <select id="selCoin" class="form-control" onchange="changecoin(this)">
                                    <option value="ETH">Ethereum</option>
                                    <option value="BTC">BitCoin</option>
                                </select> -->
                                <button id="btnCreateDCRM" type="button" class="btn btn-primary form-control" onclick="getDCRMAccount(this)">
                                    Generate DCRM Account</button>
                            </div>
                            <div id="dcrm_show" style="width: 420px;font-weight: bolder;font-size:16px; text-align: center;display: none;">
                            <div style="color:blue;font-weight: bolder;font-size:16px;margin:8px 0;">Please transfer <span class="coinspan">rinkeby ether</span> to the following lock in address:</div>
                            <div id="qrcode" style="display: inline-block;"></div>
                            <div id="qrcodetxt"></div>
                            </div>
                            <!--    <div class="form-group col-md-6">
                                <label for="nodeNumber">
                                    Number of Supreme Nodes</label>
                                <input type="number" class="form-control" id="nodeNumber" value="4" disabled placeholder="Please input the number of Supreme Nodes to generate the FUSION DCRM private key: (For example: 4)" />
                            </div>-->
                            </form>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane" id="lockout">
                    <div class="panel panel-default ethpanel">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                DCRM Test (Lock Out)</h3>
                        </div>
                        <div class="panel-body">
                            <form>
                            <div class="form-group">
                                <label for="ethDCRMAddress">
                                    From DCRM Address</label>
                             <!--    <input type="text" class="form-control" id="ethDCRMAddress" placeholder="Please tranfer some Rinkeby Testnet ETH to the DCRM Address: cbaebd15099c5b9a3013577be04e8a66858c7eb9, (For example: transfer 0.1 Rinkeby Testnet ETH)"> -->
                             <select id="ethDCRMAddress" class="form-control" onclick="displayAddress(this)">
                              </select>
                            </div>
                            <div class="form-group">
                                <label for="ethReceiveAddress">
                                    To <span class="coinname">ETH</span> Address</label>
                                <input type="text" class="form-control" id="ethReceiveAddress" placeholder="Please input Ethereum Rinkeby Testnet Address to receive ETH, not with the prefix '0x': (For example: 0520e8e5e08169c4dbc1580dc9bf56638532773a )">
                            </div>
                            <div class="form-group">
                                <label for="ethTransferValue">
                                    Transfer Value (<span class="coinname">ETH</span>)</label>
                                <input type="text" class="form-control" id="ethTransferValue" placeholder="Please input transfer value">
                            </div>
                            <button type="button" class="btn btn-primary" onclick="dcrmSignTranForEth()">
                                Generate DCRM Signed Transaction</button>
                            </form>
                        </div>
                    </div>
                    <div class="panel panel-default btcpanel">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                DCRM Test (Lock Out)</h3>
                        </div>
                        <div class="panel-body">
                            <form>
                            <div class="form-group">
                                <label for="DCRMAddress">
                                    From DCRM Address</label>
                               <!--  <input type="text" class="form-control" id="btcDCRMAddress" placeholder="Please tranfer some Testnet BTC to the DCRM Address: cbaebd15099c5b9a3013577be04e8a66858c7eb9, (For example: transfer 0.1 Testnet BTC)"> -->
                               <select id="btcDCRMAddress" class="form-control" onclick="displayAddress(this)">
                              </select>
                            </div>
                            <div class="form-group">
                                <label for="btcReceiveAddress">
                                    To BTC Address</label>
                                <input type="text" class="form-control" id="btcReceiveAddress" placeholder="Please input Bitcoin Testnet Address (P2PKH, with the leading symbol m or n) to receive BTC, not with the prefix '0x': (For example: mwv8hYDLHaoA4DXMFNjBTX5VFosMbRVVvS )">
                            </div>
                            <div class="form-group">
                                <label for="btcTransferValue">
                                    Transfer Value (BTC)</label>
                                <input type="text" class="form-control" id="btcTransferValue" placeholder="Please input transfer value">
                            </div>
                            <button type="button" class="btn btn-primary" onclick="dcrmSignTranForBtc()">
                                Generate DCRM Signed Transaction</button>
                            </form>
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                DCRM Signed Transaction</h3>
                        </div>
                        <div class="panel-body">
                            <form>
                            <div class="form-group">
                                <label for="signTransaction">
                                    DCRM Signed Transaction</label>
                                <textarea id="signTransaction" class="form-control" cols="20" rows="8"></textarea>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="sendTransaction()">
                                Send Transaction</button>
                                <div style="float:right;display: none;" id="lookurl"><a href="https://rinkeby.etherscan.io/tx/" target="_blank">Lock out crosschain transaction success, please check the TX status: <br/><span style="font-weight: bolder;color: blue;" class="lookurl">https://rinkeby.etherscan.io/tx/</span></a></div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div id="footer">
    <div class='footer container'>
		<a href="https://www.fusion.org" target="_blank" class='logo'><img src="images/fusion.png"/></a>
		<span class="copyright">© 2018 FUSION Foundation. All rights reserved.</span>
		<a href="https://gitter.im/FUSIONDC/" target="_blank" class='smicon'><img src="images/gitter.png"/></a>
		<a href="https://github.com/FUSIONFoundation/dcrm-go" target="_blank" class='smicon'><img src="images/github.png"/></a>
		
		</div>
    </div>
    <div class="modal fade" id="maskLayerModal">
        <div class="modal-dialog" style="text-align: center; margin-top: 100px;">
        <div id="pagetimer" style="color:#fff;font-size:40px;font-weight: bolder;"></div>
            <img style='width:60px;height: 60px;margin:10px 0 20px 0;' alt="" src="data:image/gif;base64,R0lGODlhGQAZAJECAK7PTQBjpv///wAAACH/C05FVFNDQVBFMi4wAwEAAAAh/wtYTVAgRGF0YVhNUDw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo5OTYyNTQ4Ni02ZGVkLTI2NDUtODEwMy1kN2M4ODE4OWMxMTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RUNGNUFGRUFGREFCMTFFM0FCNzVDRjQ1QzI4QjFBNjgiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RUNGNUFGRTlGREFCMTFFM0FCNzVDRjQ1QzI4QjFBNjgiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjk5NjI1NDg2LTZkZWQtMjY0NS04MTAzLWQ3Yzg4MTg5YzExNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5OTYyNTQ4Ni02ZGVkLTI2NDUtODEwMy1kN2M4ODE4OWMxMTQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4B//79/Pv6+fj39vX08/Lx8O/u7ezr6uno5+bl5OPi4eDf3t3c29rZ2NfW1dTT0tHQz87NzMvKycjHxsXEw8LBwL++vby7urm4t7a1tLOysbCvrq2sq6qpqKempaSjoqGgn56dnJuamZiXlpWUk5KRkI+OjYyLiomIh4aFhIOCgYB/fn18e3p5eHd2dXRzcnFwb25tbGtqaWhnZmVkY2JhYF9eXVxbWllYV1ZVVFNSUVBPTk1MS0pJSEdGRURDQkFAPz49PDs6OTg3NjU0MzIxMC8uLSwrKikoJyYlJCMiISAfHh0cGxoZGBcWFRQTEhEQDw4NDAsKCQgHBgUEAwIBAAAh+QQFCgACACwAAAAAGQAZAAACTpSPqcu9AKMUodqLpAb0+rxFnWeBIUdixwmNqRm6JLzJ38raqsGiaUXT6EqO4uIHRAYQyiHw0GxCkc7l9FdlUqWGKPX64mbFXqzxjDYWAAAh+QQFCgACACwCAAIAFQAKAAACHYyPAsuNH1SbME1ajbwra854Edh5GyeeV0oCLFkAACH5BAUKAAIALA0AAgAKABUAAAIUjI+py+0PYxO0WoCz3rz7D4bi+BUAIfkEBQoAAgAsAgANABUACgAAAh2EjxLLjQ9UmzBNWo28K2vOeBHYeRsnnldKBixZAAA7" />
            <div class="masktext"></div>
        </div>
    </div>
    <script src="./bootstrap-3.3.7/js/jquery.min.js" type="text/javascript"></script>
    <script src="./javascripts/web3.min.js" type="text/javascript"></script>
    <script src="./javascripts/common.js" type="text/javascript"></script>
    <script src="./javascripts/qrcode.min.js" type="text/javascript"></script>
    <script src="./bootstrap-3.3.7/js/jquery.form.js?v=1" type="text/javascript"></script>
    <script src="./bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="./src/biginteger.js" type="text/javascript"></script>
    <script src="./src/cryptojs.js" type="text/javascript"></script>
    <script src="./src/cryptojs.ripemd160.js" type="text/javascript"></script>
    <script src="./src/cryptojs.sha256.js" type="text/javascript"></script>
    <script src="./src/securerandom.js" type="text/javascript"></script>
    <script src="./src/bitcoinjs-lib.js" type="text/javascript"></script>
    <script src="./src/bitcoinjs-lib.util.js" type="text/javascript"></script>
    <script src="./src/ellipticcurve.js" type="text/javascript"></script>
    <script src="./src/bitcoinjs-lib.base58.js" type="text/javascript"></script>
    <script src="./src/bitcoinjs-lib.ecdsa.js" type="text/javascript"></script>
    <script src="./src/bitcoinjs-lib.eckey.js" type="text/javascript"></script>
    <script src="./src/bitcoinjs-lib.address.js" type="text/javascript"></script>
    <script src="./javascripts/erc20_config.js" type="text/javascript"></script>

    <script type="text/javascript">
        var domain = 'http://47.107.50.83:8018/';

        var pagetimer;
		var key;
		var nodes_Ip;

        $(function () {
            $(".btcpanel").hide();
            $('#tab_content').hide();
            nodes_Ip=[{
            	name:'Bank of China',
            	value:'54.169.254.177'
            },{
            	name:'Bank of America',
            	value:'13.81.29.241'
            },{
            	name:'Bank of Europe',
            	value:'54.254.202.218'
            },{
            	name:'Bank of Japan',
            	value:'54.93.156.88'
            }];

            $('#selNode').html();
            var html='';
            for(var i=0;i<nodes_Ip.length;i++){
				html+='<option value="http://'+nodes_Ip[i].value+':40405">'+nodes_Ip[i].name+'</option>';
            }
            $('#selNode').html(html);

			$("#selCoin").val("ETH");
            //get_nodeinfo();
        })

        function get_nodeinfo(){
        	var inputdata={};
        	inputdata.jsonrpc = "2.0";
	        inputdata.method = "fsn_dcrmNodeInfo";
			inputdata.id = 67;

        	$.ajax({
	            url: 'http://47.92.168.85:40405/',
	            type: 'post',
	            data: JSON.stringify(inputdata),
	            dataType: 'json',
	            contentType: 'application/json',
	            success: function (data) {
	                console.log(data);
	                hideMaskLayer();
	                if(data&&data.result){
	                    
	                }else if(data&&data.error){
	                	showTip("Error:"+ JSON.stringify(data.error)+'<br/><br/>Please Retry!');
	                }
	            },
	            error: function (e) {
	                hideMaskLayer();
	                console.log("error", e);
	                showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
	            }
	        });
        }

        function get_ipinfo(){
        	var str='';
            for(var i=0;i<nodes_Ip.length;i++){
				str+='Node'+(i+1)+': '+nodes_Ip[i].value+'<br/>';
            }
            return str;
        }

        function createKey(obj) {
            $(obj).attr("disabled","disabled");
            $("#btnCreateKey").attr("disabled","disabled");
		    $("#btnImportKey").attr("disabled","disabled");

            $("#privateKey").attr("readonly","readonly");
			key = new Bitcoin.ECKey(false);
			key.setCompressed(false);
            var pubkey = key.getPubKeyHex();
            var privatekey = key.getBitcoinHexFormat();
            $("#privateKey").val(privatekey);
            $("#pubKey").val(pubkey);
            if (privatekey) {
            	$("#priv_warn").show();
            	$('#tab_content').show();
            }
        }

         function importKey(obj) {
            var privatekey = $("#privateKey").val();
            if (privatekey) {
            	privatekey=privatekey.toLowerCase().indexOf('0x')==0?privatekey.substring(2):privatekey;
            	if(privatekey.length==64){
		            key = new Bitcoin.ECKey(privatekey);
		            key.setCompressed(false);
		            var pubkey =key.getPubKeyHex();

					$("#privateKey").val(privatekey);
		            $("#pubKey").val(pubkey);
		            if (privatekey) {
		            	$("#priv_warn").show();
		            }

		            getrpc_dcrmAccount(pubkey);
	        	}else{
	        		showTip('Private key error!');
	        	}
        	}else{
        		showTip('Please input private key!');
        	}
        }

        function disablePrivKey(){
		    $("#btnCreateKey").attr("disabled","disabled");
		    $("#btnImportKey").attr("disabled","disabled");

		    $('#tab_content').show();
		    $("#privateKey").attr("readonly","readonly");
        }

        function getrpc_dcrmAccount(pubkey){
			if (pubkey) {
	            var inputdata = {};

	            var para = new Array();
	            para.push("0x" + pubkey);

	            inputdata.jsonrpc = "2.0";
	            inputdata.method = "fsn_dcrmGetAccountList";
	            inputdata.params = para;
	            inputdata.id = 67;

	            console.log("json", JSON.stringify(inputdata)); 

	            showMaskLayer("Getting Account List,please wait...");
	            
	            $.ajax({
	                url: $("#selNode").val(),//"http://47.92.168.85:40405/",
	                type: 'post',
	                data: JSON.stringify(inputdata),
	                dataType: 'json',
	                contentType: 'application/json',
	                success: function (data) {
	                    console.log(data);
	                    hideMaskLayer();
	                    $('#ethDCRMAddress').html('<option value="">-- please select --</option>');
	                    $('#btcDCRMAddress').html('<option value="">-- please select --</option>');
	                    if(data&&data.result){
	                    	disablePrivKey();
	                    	var $data=JSON.parse(data.result);
	                    	console.log("[accountlist]",$data);
	                    	for(var i=0;i<$data.ACCOUNTLIST.length;i++){
	                    		$('#'+$data.ACCOUNTLIST[i].COINTYPE.toLowerCase()+'DCRMAddress').append('<option value="'+$data.ACCOUNTLIST[i].DCRMPUBKEY+'">'+$data.ACCOUNTLIST[i].DCRMADDRESS+'</option>');
	                    	}
	                	}else if(data&&data.error){
	                		showTip("Error:"+ JSON.stringify(data.error)+'<br/><br/>Please Retry!');
	                	}
	                },
	                error: function (e) {
	                    hideMaskLayer();
	                    console.log("error", e);
	                    showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
	                }
	            });
        	}else{
        		showTip("Error: Please Input Private Key!");
        	}
        }

		function displayAddress(obj){
			if ($(obj).val()) {
				$('#dcrm_show').show();
				var addr=$(obj).find("option:selected").text();
				createQrCode(addr);			
			}else{
				$('#dcrm_show').hide();
				$("#qrcode").html("");
			}
		}

        function createQrCode(val){
            $("#dcrm_show").show();
            $("#qrcode").html('');
            var qrcode = new QRCode(document.getElementById("qrcode"), {
                width: 200,
                height: 200
            });
            qrcode.makeCode(val);
            $("#qrcodetxt").text(val);
        }

        function showMaskLayer(val){
        	$("#maskLayerModal .masktext").html(val);
            $("#maskLayerModal").modal({ backdrop: 'static', keyboard: false });
            var tempIndex=0;
            $("#pagetimer").text(tempIndex++);
        	pagetimer=window.setInterval(function(){
				$("#pagetimer").text(tempIndex++);
        	},1000);
        }

        function hideMaskLayer(){
        	window.clearInterval(pagetimer); 
        	$("#maskLayerModal").modal('hide');
        }

        function changecoin(obj) {
            if ($(obj).val() == "BTC") {
                $(".ethpanel").hide();
                $(".btcpanel").show();
                $('.coinspan').text('testnet btc');
                displayAddress($('#btcDCRMAddress')[0]);
            } else {
                $(".ethpanel").show();
                $(".btcpanel").hide();
                $('.coinspan').text('rinkeby ether');
                displayAddress($('#ethDCRMAddress')[0]);
                $('.coinname').text($(obj).val());
            }
        }

        function getDCRMAccount(obj) {
        	$("#signTransaction").text('');
        	$("#dcrm_show").hide();
            //$(obj).attr("disabled","disabled");
            var pubkey = $("#pubKey").val();
            var coin = $("#selCoin").val();
			if (pubkey&&coin) {
	            var inputdata = {};

	            var para = new Array();
	            para.push("0x" + pubkey);
	            coin=(coin=='BTC'?'BTC':'ETH');
	            para.push(coin);        

	            inputdata.jsonrpc = "2.0";
	            inputdata.method = "fsn_dcrmReqAddress";
	            inputdata.params = para;
	            inputdata.id = 67;

	            console.log("json", JSON.stringify(inputdata)); 

	            showMaskLayer("Creating "+coin+" address,please wait...<br/><br/><p>DCRM address is distributedly generating by the following nodes:<br/>"+get_ipinfo()+"</p>");
	            
	            $.ajax({
	                url: $("#selNode").val(),//"http://47.92.168.85:40405/",
	                type: 'post',
	                data: JSON.stringify(inputdata),
	                dataType: 'json',
	                contentType: 'application/json',
	                success: function (data) {
	                    console.log(data);
	                    hideMaskLayer();
	                    if(data&&data.result){
	                    	var $data=JSON.parse(data.result);
	                    	$('#'+$data.COINTYPE.toLowerCase()+'DCRMAddress').append('<option value="'+$data.DCRMPUBKEY+'">'+$data.DCRMADDRESS+'</option>');
	                    	createQrCode($data.DCRMADDRESS);
	                    	$('#'+$data.COINTYPE.toLowerCase()+'DCRMAddress').val($data.DCRMPUBKEY);
	                	}else if(data&&data.error){
	                		showTip("Error:"+ JSON.stringify(data.error)+'<br/><br/>Please Retry!');
	                	}
	                },
	                error: function (e) {
	                    hideMaskLayer();
	                    console.log("error", e);
	                    showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
	                    //$(obj).removeAttr("disabled");
	                }
	            });
        	}else{
        		showTip("Error: Please Generate Private Key!");
        	}
        }

        /* generate dcrm sign for eth */
        function dcrmSignTranForEth() {
        	$("#signTransaction").text('');
			$("#lookurl").hide();
            
            var to_address=$("#ethReceiveAddress").val();
            var to_value=$("#ethTransferValue").val();
            var address = $("#ethDCRMAddress").val()?$("#ethDCRMAddress").find("option:selected").text():'';//.val();
            var coin = $("#selCoin").val();
            
            if (to_address&&to_value&&address&&coin) {
            	to_address=to_address.toLowerCase().indexOf('0x')==0?to_address:('0x'+to_address);
            	address=address.toLowerCase().indexOf('0x')==0?address:('0x'+address);

            	if (to_address.length==42&&address.length==42) {
            		var reg = /^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/;

            		if (reg.test(to_value)) {
            			showMaskLayer("Lock out is in progress, please wait...<br/><br/><p>Distributed computing by the following p2p nodes:<br/>"+get_ipinfo()+"</p>");
          
			            var Web3 = require('web3');

			            if (typeof web3 !== 'undefined') {
			              web3 = new Web3(web3.currentProvider);
			            } else {
			              web3 = new Web3(new Web3.providers.HttpProvider(domain));
			            }

		                web3.eth.getTransactionCount(address,function(error,result){
		                	if (!error){
		                		console.log(result);

		                		var nonceHex=decToHex(result.toString());
		                		
		                		if(coin=='ETH'){
		                			var value = web3.toWei(to_value, 'ether');
		                			var valHex=decToHex(value);
		                			getEthTxHash(to_address,valHex,nonceHex);
		                		}else{
									var contractAddress,contractABI;
			                		if(coin=='FSN'){
			                			contractAddress =FSN.contractAddr;
										contractABI = FSN.contractAbi;
			                		}else if(coin=='TRX'){
			                			contractAddress =TRX.contractAddr;
										contractABI = TRX.contractAbi;
			                		}

									var MMTContract = web3.eth.contract(contractABI).at(contractAddress);
									//var decimal = MMTContract.decimals();
									MMTContract.decimals.call(function(err,result){
										var decimal =result.toString();
										var coinval=parseFloat(to_value)*Math.pow(10, decimal);
										console.log(coin,coinval);
						                var valHex=decToHex(coinval.toString());

										var erc20_data=MMTContract.transfer.getData(to_address, valHex);

										getEthTxHash(contractAddress,valHex,nonceHex,erc20_data);
									});
								}
		                	}else{
								showTip(error);
								hideMaskLayer();
		                	}
		                });
		                
	            	}else{
	            		showTip('Transfer value error!');
	            	}
            	}else{
            		showTip('Address error!');
            	}
            }else{
                showTip('Parameter can not be empty!');
            }
        }


        function getEthTxHash(to_address,to_value,nonce,erc20_data){
        	$.ajax({
                url: "/build_EthTx",
                type: 'post',
                data: { to_address:to_address, to_value:to_value,nonce:nonce,erc20_data:erc20_data},
                dataType: 'json',
                success: function (data) {
                   console.log("sighash",data);
                   if(data&&data.sighash){
						getrpc_dcrmSignForEth(data.sighash,to_address,to_value,nonce,erc20_data);
                   }else{
                   		hideMaskLayer();
                   		showTip(' Build sign hash empty!');
                   }
                },
                error:function(e){
                   console.log("e",e);
                   showTip("Error:"+JSON.stringify(aa)+'<br/><br/>Please Retry!');
                   hideMaskLayer();
                }
            });
        }

        function getrpc_dcrmSignForEth(hash,to_address,to_value,nonce,erc20_data){
        	if (!key) {
        		hideMaskLayer();
        		showTip('Error: sign is undefined! ');
        		return;
        	}
            var hasharray = Crypto.util.hexToBytes(hash);
            var signarray = key.sign(hasharray);
            var dcrmaddr=$('#ethDCRMAddress').find("option:selected").text();
            var obj = key.parseSigHex(signarray);
            console.log("[rs]", obj.r, obj.s);

			//var coin = $("#selCoin").val();

            var inputdata = {};

            var para = new Array();

            para.push("0x" + obj.r + obj.s);
            para.push("0x"+hash);
            para.push(dcrmaddr);
            para.push('ETH');

            inputdata.jsonrpc = "2.0";
            inputdata.method = "fsn_dcrmSign";
            inputdata.params = para;
            inputdata.id = 67;

            console.log("[dcrmsign_EthIn]",JSON.stringify(inputdata));
         
            $.ajax({
                url: $("#selNode").val(),//"http://47.92.168.85:40405/",
                type: 'post',
                data: JSON.stringify(inputdata),
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    console.log("[dcrmsign_EthOut]",data);
                    
                    if(data&&data.result){
                    	var dcrmsig=data.result;
	                    $.ajax({
	                        url: "/build_EthTx",
	                        type: 'post',
	                        data: { to_address:to_address, to_value:to_value,nonce:nonce,sig:dcrmsig,erc20_data:erc20_data},
	                        dataType: 'json',
	                        success: function (data) {
	                           hideMaskLayer();
	                           console.log("[node_Out]",data);
	                           if(data){
		                           	if(data.error){
			                			showTip("Error:"+ JSON.stringify(data.error)+'<br/><br/>Please Retry!');
		                           	}else{
		                           		var tx_hash=data.txhash;
		                           		if(tx_hash){
		                           			$("#signTransaction").text(tx_hash);
		                           		}else{
		                           			showTip(' RPC result empty!');
		                           		}
		                           	}
		                	    }else{
		                	    	showTip(' Tx hash empty!');
		                	    }
	                        },
	                        error:function(e){
	                           hideMaskLayer();
	                           console.log("e",e);
	                           showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
	                        }
	                    });
                    }else{
                    	hideMaskLayer();
                    	showTip('Dcrm Sign Fail!<br/><br/>Please Retry!');
                    }
                },
                error: function (e) {
                    console.log("error", e);
                    hideMaskLayer();
                    showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
                }
            });
        }

        /* generate dcrm sign for btc */
		function dcrmSignTranForBtc(){

			$("#signTransaction").text('');
			$("#lookurl").hide();

			var to_address=$("#btcReceiveAddress").val();
            var to_value=$("#btcTransferValue").val();
            var address = $("#btcDCRMAddress").val()?$("#btcDCRMAddress").find("option:selected").text():'';//.val();
            var coin = $("#selCoin").val();

            if (to_address&&to_value&&address&&coin) {

            	var reg = /^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/;
            	if(to_address.length<26||to_address.length>35){
            		showTip('To BTC Address error!');
            		return;
            	}
            	var re = /^[A-Z0-9]+$/i;
  				if (!re.test(to_address)){
  					showTip('To BTC Address error!');
  					return;
  				}
            	if (!reg.test(to_value)){
					showTip('Transfer value error!');
					return;
            	}

            	showMaskLayer("Lock out is in progress, please wait...<br/><br/><p>Distributed computing by the following p2p nodes:<br/>"+get_ipinfo()+"</p>");

            	$.ajax({
                        url: "https://api.blockcypher.com/v1/btc/test3/addrs/"+address,
                        type: 'get',
                        data: null,
                        dataType: 'json',
                        success: function (data) {
                            console.log(data);
                            var tx_hash;
                            var tx_output_n;

                           if (data&&data.address) {
								if (data.balance==0) {
									hideMaskLayer();
									if(data.unconfirmed_balance!=0){
										showTip('wait utxo confirm!');
									}else{
										showTip('Insufficient balance.');
									}
									
								}else{
									var utxos=data.txrefs;
									for(var i=0;i<utxos.length;i++){
										if (utxos[i].tx_input_n==-1&&utxos[i].spent==false) {
											tx_hash=utxos[i].tx_hash;
											tx_output_n=utxos[i].tx_output_n;//utxos[i].value
											break;
										}										
									}

									if (tx_hash) {
										var val=parseFloat(to_value)*100000000;
										console.log(val);
										getBtcTxHash(tx_hash,tx_output_n,to_address,val);
									}else{
										hideMaskLayer();
										showTip('Insufficient balance.');
									}
								}
                           }else{
                           		hideMaskLayer();
                           		showTip('address error!');
                           }
                        },
                        error:function(e){
                        	hideMaskLayer();
                           console.log("e",e);
                           showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
                        }
                });
            }else{
                showTip('Parameter can not be empty!');
            }
		}

		function getBtcTxHash(utxo,utxoIndex,to_address,to_value){

			var pubkey=$("#btcDCRMAddress").val();

			console.log("[getBtcTxHash]: ",utxo,utxoIndex,to_address,to_value,pubkey);

			$.ajax({
				url: "/build_BtcTx",
				type: 'post',
				data: { utxo:utxo,utxoIndex:utxoIndex,to_address:to_address, to_value:to_value,pubkey:pubkey},
				dataType: 'json',
				success: function (data) {
				    console.log("[build_BtcTx]",data);
				    if(data&&data.sighash){
					    getrpc_dcrmSignForBtc(utxo,utxoIndex,data.sighash,to_address,to_value,pubkey);
					}else{
						hideMaskLayer();
		                showTip(' Build sign hash empty!');
					}
				},
				error:function(e){
				    hideMaskLayer();
				    console.log("e",e);
				    showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
				}
			});
		}

		function getrpc_dcrmSignForBtc(utxo,utxoIndex,hash,to_address,to_value,pubkey){
        	if (!key) {
        		hideMaskLayer();
        		showTip('Error: sign is undefined! ');
        		return;
        	}
            var hasharray = Crypto.util.hexToBytes(hash);
            var signarray = key.sign(hasharray);
            var obj = key.parseSigHex(signarray);
            var dcrmaddr=$('#btcDCRMAddress').find("option:selected").text();
            var coin = $("#selCoin").val();

            var inputdata = {};

            var para = new Array();

            para.push("0x" + obj.r + obj.s);
            para.push("0x"+hash);
            para.push(dcrmaddr);
            para.push(coin);

            inputdata.jsonrpc = "2.0";
            inputdata.method = "fsn_dcrmSign";
            inputdata.params = para;
            inputdata.id = 67;

            console.log("[fsn_dcrmSign_BtcIn]",JSON.stringify(inputdata));
   
            $.ajax({
                url: $("#selNode").val(),//"http://47.92.168.85:40405/",
                type: 'post',
                data: JSON.stringify(inputdata),
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    console.log("[fsn_dcrmSign_BtcOut]",data);
                    if (data&&data.result) {
                    	var dcrmsig=data.result.substring(0,128);
						$.ajax({
							url: "/build_BtcTx",
							type: 'post',
							data: { utxo:utxo,utxoIndex:utxoIndex,to_address:to_address, to_value:to_value,pubkey:pubkey,sig:dcrmsig},
							dataType: 'json',
							success: function (data) {
							    hideMaskLayer();
							    console.log("[node_Out]",data);
							    if(data){
								    var tx_hash=data.txhash;
								    if(tx_hash){
		                           		$("#signTransaction").text(tx_hash);
		                           	}else{
		                           		showTip(' RPC result empty!');
		                           	}
								}else{
		                	    	showTip(' Tx hash empty!');
		                	    }
							},
							error:function(e){
							    hideMaskLayer();
							    console.log("e",e);
							    showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
							}
						});
					}else{
                    	hideMaskLayer();
                    	showTip('Dcrm Sign Fail!<br/><br/>Please Retry!');
                    }
                },
                error: function (e) {
                    console.log("error", e);
                    hideMaskLayer();
                    showTip("Error:"+ JSON.stringify(e)+'<br/><br/>Please Retry!');
                }
            });
        }

        /* Broadcast Transaction */
        function sendTransaction(){

            var tx_hash=$("#signTransaction").val();
            console.log(tx_hash);
            if (tx_hash) {
	            $("#lookurl").hide();

	            showMaskLayer("Send Transation...");
	            var coin=$('#selCoin').val();

		        if (coin == 'BTC') {
		            var inputdata = {};
		            inputdata.tx = tx_hash;

		            $.ajax({
		                url: 'https://api.blockcypher.com/v1/btc/test3/txs/push',
		                type: 'post',
		                data: JSON.stringify(inputdata),
		                dataType: 'json',
		                contentType: 'application/json',
		                success: function (data) {
		                    console.log(data);
		                    hideMaskLayer();
		                    var $tx = data.tx;
		                    var hash = $tx.hash;
		                    $("#lookurl a").attr("href", "https://live.blockcypher.com/btc-testnet/tx/" + hash);
		                    $("#lookurl .lookurl").text("https://live.blockcypher.com/btc-testnet/tx/" + hash);
		                    $("#lookurl").show();
		                },
		                error: function (e) {
		                    hideMaskLayer();
		                    console.log("error", e.responseText);

		                    showTip("[Error] " + JSON.parse(e.responseText).error + '<br/><br/>Please Retry!');
		                }
		            });
		        } else {//ETH ERC20 Broadcast Transaction
		            var Web3 = require('web3');

		            if (typeof web3 !== 'undefined') {
		                web3 = new Web3(web3.currentProvider);
		            } else {
		                // set the provider you want from Web3.providers
		                web3 = new Web3(new Web3.providers.HttpProvider(domain));
		            }
		            if (tx_hash.toLowerCase().indexOf('0x') == -1) {
		                tx_hash = "0x" + tx_hash;
		            }

		            web3.eth.sendRawTransaction(tx_hash, function (err, hash) {
		                hideMaskLayer();
		                if (err) {
		                    console.log(err);
		                    var endIndex = err.toString().indexOf('at ');
		                    if (endIndex > -1) {
		                        showTip(err.toString().substring(0, endIndex));
		                    } else {
		                        showTip(err.toString());
		                    }
		                } else {
		                    console.log(hash); // "0x7f9fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a91385"
		                    $("#lookurl a").attr("href", "https://rinkeby.etherscan.io/tx/" + hash);
		                    $("#lookurl .lookurl").text("https://rinkeby.etherscan.io/tx/" + hash);
		                    $("#lookurl").show();
		                }
		            });
		        }
    		}else{
    			showTip('Please Generate DCRM Signed Transaction!');
    		}
        }
        //baidu
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "https://hm.baidu.com/hm.js?c1d8355244d33be9abb1c0c996889a9a";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
</body>
</html>
